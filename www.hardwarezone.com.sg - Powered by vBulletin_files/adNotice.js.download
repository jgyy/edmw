var HwzAdNotice = new Class({

	cookieName: 'hwzAdNoticeLast',

	adNoticeDatas: [],

	totalAdNotice: 0,

	fixedOK: true,

	slideFx :  null,

	initialize: function(elements, options) {
		if (elements.length < 1) {
			return;
		}

		for (var i=0; i<elements.length; i++) {
			elements[i].position = elements.length - i;
		}

		options = options || {};
		if ('cookieName' in options && /^hwzAdNoticeLast_[0-9a-f]+$/.test(options.cookieName)) {
			this.cookieName = options.cookieName;
		}

		var oBody = $$('body')[0];
		var oMobNav = $('nav-mb-main');
		var sCookieName = this.cookieName;
		var aElements = elements.slice();//duplicate for mob

		oBody.addClass('init_ad_mob_notice');

		// create main container
		var adNotice = new Element('div', {
			'id': 'hwz_ad_notice_cont'
		});

		// inject main container to body
		adNotice.inject(oBody);

		this.fixedOK = (adNotice.getStyle('position') == 'fixed');

		// create header notice
		var headerNotice = new Element('div', {
			'id' : 'hwz_ad_notice_header'
		});

		// inject header to main container
		adNotice.adopt(headerNotice);

		// check cookie to display flag active or not
		var cookieExist = Cookie.read(this.cookieName);
		var disp = 'open';

		$('hwz_ad_notice_header').adopt(
			new Element('div', {
				'id' : 'hwz_ad_notice_icon_header'
			})
		);

		$('hwz_ad_notice_icon_header').adopt(
			new Element('span', {
				'id' : 'hwz_ad_notice_icon_header-txt',
				'html' : 'Notifications'
			})
		);

		$('hwz_ad_notice_icon_header').adopt(
			new Element('span', {
				'id' : 'hwz_ad_notice_red-txt',
				'html' : elements.length
			})
		);



		// create notif container
		var notifCont = new Element('div', {
			'id' : 'hwz_ad_notice_list_out_cont'
		});

		var notifInnerCont = new Element('div', {
			'id' : 'hwz_ad_notice_list_inner_cont'
		});

		adNotice.adopt(notifCont);
		$('hwz_ad_notice_list_out_cont').adopt(notifInnerCont);

		/*
		* adding bubble
		*/

		var _this = this;
		var el = elements.pop();
		var ctr = 'bubble';
		var ids = 'hwz_ad_notice_post_'+ctr;
		var idp = 'hwz_ad_notice_ppost_'+ctr;
		var ida = 'hwz_ad_notice_apost_'+ctr;
		var tempNotif = new Element('div', {
			'id' : ids,
			'class' : 'hwz_ad_notice_post_list'
		});

		tempNotif.inject($('hwz_ad_notice_list_out_cont'), 'top' );

		var oLink = new Element('a', {
			'id' : ida,
			'href' : el.link,
			'target' : '_blank',
			'data-title' : el.title,
			'data-position' : el.position,
		});
		if (typeof(hwz_ga_click) != 'undefined') {
			hwz_ga_click(oLink, 'Notifications', 'Click', el.title, { position: ~~el.position });
		}
		$(ids).adopt(oLink);

		$(ida).adopt(
			new Element('img', {'class' : 'hwz_ad_notice_list_thumb', 'src' : el.thumbsrc}),
			new Element('div', {'id' : idp, 'class' : 'hwz_ad_notice_post_list_text'}),
			new Element('div', {'class' : 'clear'})
		);

		$(idp).adopt(
			new Element('div', {'class' : 'hwz_ad_notice_display_title', 'text' : el.title}),
			new Element('div', {'class' : 'hwz_ad_notice_display_time', 'text' : el.displaytime})
		);

		$(ids).adopt(new Element('div', {'class' : 'hwz_ad_notice_post_line'}));

		if (elements.length > 0) {
			var expand_wrapper = new Element('div', {'id' : 'expand-notice-wrapper', 'class' : 'hwz_ad_notice_expand_wrapper'});

			$(expand_wrapper).adopt(
				new Element(
					'span',
					{
						'class' : 'expand-notice-cls',
						'text': 'View More',
						'id' : 'expand-notice',
						'events': {
							click: function(event){ //expan click event
								event.stop();
								_this.toggleHwzNotice('open');

								var additionalData = new Array();
								for (var i=0; i<_this.adNoticeDatas.length - 1; i++) {
									additionalData.push(_this.adNoticeDatas[i]);
								}

								_this.gaImpression(additionalData);
								additionalData = null;
							}
						},
					}
				)
			);
			$(ids).adopt(expand_wrapper);
		}

		var ctr = elements.length;
		this.totalAdNotice = elements.length + 1;//el the bubble
		//put back the bubble data
		this.adNoticeDatas.unshift(el);

		while (elements.length > 0) {
			var el = elements.pop();
			this.adNoticeDatas.unshift(el);
			var ids = 'hwz_ad_notice_post_'+ctr;
			var idp = 'hwz_ad_notice_ppost_'+ctr;
			var ida = 'hwz_ad_notice_apost_'+ctr;
			var tempNotif = new Element('div', {
				'id' : ids,
				'class' : 'hwz_ad_notice_post_list'
			});

			$('hwz_ad_notice_list_inner_cont').adopt(tempNotif);

			var oLink = new Element('a', {
				'id' : ida,
				'href' : el.link,
				'target' : '_blank',
				'data-title' : el.title,
				'data-position' : el.position,
			});
			if (typeof(hwz_ga_click) != 'undefined') {
				hwz_ga_click(oLink, 'Notifications', 'Click', el.title, { position: ~~el.position });
			}
			$(ids).adopt(oLink);

			$(ida).adopt(
				new Element('img', {'class' : 'hwz_ad_notice_list_thumb', 'src' : el.thumbsrc}),
				new Element('p', {'id' : idp, 'class' : 'hwz_ad_notice_post_list_text', 'text' : el.title}),
				new Element('div', {'class' : 'clear'})
			);

			$(idp).adopt(new Element('div', {'class' : 'hwz_ad_notice_display_time', 'text' : el.displaytime}));

			if (ctr > 1) {
				$(ids).adopt(new Element('div', {'class' : 'hwz_ad_notice_post_line'}));
			}
			else{
				$(ids).adopt(new Element('div', {'class' : 'hwz_ad_notice_last_div_padding'}));
			}
			ctr--;
		}
		this.setFunctionAdNotice(this.adNoticeDatas);

		if (!!oMobNav && aElements.length > 0) {
			var sCookieData = aElements[aElements.length - 1].created;
			var adMobNotice = new Element('div', {
				'id': 'hwz_ad_mob_notice_cont'
			});
			var adMobNoticeBar = new Element('div', {
				'id': 'hwz_ad_mob_notice_bar',
				'text': 'Notifications',
				'events': {
					'click': function(){
						var oBody = $$('body')[0];
						var adMobBody = $('hwz_ad_mob_notice_body');
						oBody.removeClass('show_ad_mob_notice');
						oBody.removeClass('show_ad_mob_notice_new');
						if (!!sCookieName && !!sCookieData) {
							// add cookie here
							var nDuration = 365;
							Cookie.write (sCookieName, sCookieData, { path: '/', duration: nDuration });
						}
					}
				}
			});
			var adMobNav = new Element('li', {
				'id': 'hwz_ad_mob_notice_nav',
				'events': {
					'click': function(){
						var oBody = $$('body')[0];
						var bWasNew = oBody.hasClass('show_ad_mob_notice_new');
						var oNoticeBody = $('hwz_ad_mob_notice_body');
						oBody.toggleClass('show_ad_mob_notice');
						oBody.removeClass('show_ad_mob_notice_new');

						if (oBody.hasClass('show_ad_mob_notice')) {
							if (!!oNoticeBody && typeof(hwz_ga) != 'undefined') {
								var aLinks = oNoticeBody.getElements('a');
								for(var i=0;i<aLinks.length;i++) {
									if (i==0 && bWasNew) continue;
									var sTitle = aLinks[i].get('text').trim();
									hwz_ga('send', 'event', 'Notifications', 'Impression', sTitle, { nonInteraction: true });
								}
							}
							if (!!sCookieName && !!sCookieData) {
								// add cookie here
								var nDuration = 365;
								Cookie.write (sCookieName, sCookieData, { path: '/', duration: nDuration });
							}
						}
					}
				}
			});
			var adMobCounter = new Element('div', {
				'id': 'hwz_ad_mob_notice_count',
				'text': aElements.length
			});
			var adMobBody = new Element('div', {
				'id': 'hwz_ad_mob_notice_body'
			});

			adMobNoticeBar.inject(adMobNotice);
			adMobBody.inject(adMobNotice);
			adMobCounter.inject(adMobNav);
			adMobNotice.inject(oMobNav);

			var oMobMenu = oMobNav.getElement('.nav-main-actions-btns');
			if (!!oMobMenu) {
				adMobNav.inject(oMobMenu);
			}

			for(var i=0;i<aElements.length;i++) {
				var adMobNoticeItem = new Element('a', {
					'href':aElements[i].link,
					'text':aElements[i].title,
					'target':'_blank'
				});
				adMobNoticeItem.setStyle('background-image', 'url("' + aElements[i].thumbsrc + '")');
				if (i < aElements.length - 1) {
					adMobNoticeItem.addClass('old');
				}
				adMobNoticeItem.inject(adMobBody, 'top');
			}

			this.checkPushdown();
		}

		setTimeout(function() {
			var oBody = $$('body')[0];
			oBody.removeClass('init_ad_mob_notice');
		}, 500);
	},

	setFunctionAdNotice : function(datas) {
		var lastData = datas[datas.length - 1];
		var cookieNames = this.cookieName;

		var hwz_header =  $('hwz_ad_notice_header');

		//add the click toggle
		hwz_header.addEvent('click', function() {
			var oBody = $$('body')[0];

			this.toggleHwzNotice();
			if (oBody.hasClass('show_ad_mob_notice')) {
				var noticeData = new Array();
				for (var i=0; i<this.adNoticeDatas.length; i++) {
					noticeData.push(this.adNoticeDatas[i]);
				}
				this.gaImpression(noticeData);
				noticeData = null;
			}

			// add cookie here
			var nDuration = 365;
			Cookie.write (cookieNames, lastData.created, { path: '/', duration: nDuration });

		}.bind(this));


	},

	checkBubble: function() {
		if (this.adNoticeDatas.length < 1) return;

		var lastData = this.adNoticeDatas[this.adNoticeDatas.length - 1];
		// check first, need to show or not
		var cookieExist = Cookie.read(this.cookieName);
		var gotNew = (!cookieExist || lastData.created > cookieExist);

		if (gotNew) {
			this.toggleHwzNotice('new');
		}

		if (this.hasNew()) {
			this.gaImpression([lastData]);
		}

			
	},

	checkPushdown: function() {
		var oBody = $$('body')[0];
		var oPushdown = $('hwz_ad_mob_pushdown');
		var adMobBody = $('hwz_ad_mob_notice_body');
		if (!adMobBody) {
			if (!!oPushdown) oPushdown.destroy();
			return;
		}
		if (!oPushdown) {
			oPushdown = new Element('div', { 'id':'hwz_ad_mob_pushdown' });
			oPushdown.inject(oBody, 'top');
		}
		var n = ~~adMobBody.getElements('a').length;
		if (n > 0) {
			if (n > 5) n = 5;
			var nHeight = 28 + (n * 88);
			oPushdown.setStyle('height', nHeight);
		}
	},

	gaImpression: function(datas) {
		if (!datas.length) return;
		if (typeof(hwz_ga) == 'undefined') return;
		for (var i=0;i<datas.length;i++) {
			var sTitle = datas[i].title;
			var nPosition = ~~datas[i].position;
			//console.log('ga send', sTitle);
			hwz_ga('send', 'event', 'Notifications', 'Impression', sTitle, { nonInteraction: true, position: nPosition });
		}
	},

	gaClick: function(o) {
		if (!$(o)) return;
		var sTitle = $(o).get('data-title');
		var nPosition = ~~$(o).get('data-position');
		if (typeof(sTitle) != 'string') return;
		hwz_ga('send', 'event', 'Notifications', 'Click', sTitle, { nonInteraction: true, position: nPosition });
	},

	toggleHwzNotice: function(s){
		var oBody = $$('body')[0];
		if (s === 'new') {
			oBody.removeClass('show_ad_mob_notice');
			oBody.addClass('show_ad_mob_notice_new');
		} else if (s === 'open') {
			oBody.addClass('show_ad_mob_notice');
			oBody.removeClass('show_ad_mob_notice_new');
		} else if (s === 'close') {
			oBody.removeClass('show_ad_mob_notice');
			oBody.removeClass('show_ad_mob_notice_new');
		} else if (this.isClosed()) {
			oBody.addClass('show_ad_mob_notice');
		} else {
			oBody.removeClass('show_ad_mob_notice');
			oBody.removeClass('show_ad_mob_notice_new');
		}

		var notice_list_out_cont= $('hwz_ad_notice_list_out_cont');
		var nBubbleHeight = $('hwz_ad_notice_list_inner_cont').getScrollSize().y;
		var nExpandHeight = (!!$('expand-notice-wrapper') ? $('expand-notice-wrapper').getScrollSize().y : 0);
		var nListHeight = $('hwz_ad_notice_post_bubble').getScrollSize().y;

		notice_list_out_cont.removeClass('scrollable');
		if (oBody.hasClass('show_ad_mob_notice_new')) {
			notice_list_out_cont.setStyle('max-height', (nListHeight + nExpandHeight) + 'px');
		} else if (oBody.hasClass('show_ad_mob_notice')) {
			var nHeight = nBubbleHeight + nListHeight;
			var nMaxHeight = Math.floor($(window).getSize().y * 0.75);
			if (nHeight > nMaxHeight) nHeight = nMaxHeight;
			notice_list_out_cont.setStyle('max-height', nHeight + 'px');
			notice_list_out_cont.addClass('scrollable');
		} else {
			notice_list_out_cont.setStyle('max-height', 0);
		}
	},

	isClosed: function(){
		var oBody = $$('body')[0];
		return (!oBody.hasClass('show_ad_mob_notice') && !oBody.hasClass('show_ad_mob_notice_new'));
	},

	hasNew: function(){
		var oBody = $$('body')[0];
		return (!!oBody.hasClass('show_ad_mob_notice_new'));
	},

	hideRedText: function(){
		var red_text = $('hwz_ad_notice_red-txt');
		red_text.hide()
	}

});
